namespace = Plus

#reserved: Plus.1900 to Plus.1950

#######################################
# MUSLIM EVENTS
# Adapted from Heretic Pride by Rylock
#######################################

### ANARCHY AT SAMARRA EVENTS

# Caliphate administration seized from a weak caliph
narrative_event = {
	id = Plus.1900
	title = EVTNAME_Plus_1900
	desc = EVTDESC_Plus_1900
	picture = GFX_evt_throne_room_arabic
	
	major = yes
	hide_from = yes
	show_ROOT = yes
	
	only_playable = yes
	prisoner = no
	only_men = yes
	ai = yes
	
	trigger = {
		has_landed_title = d_sunni
		year = 800
		realm_size = 200
		NOT = {
			diplomacy = 10
			martial = 10
			stewardship = 10
			intrigue = 10
			has_global_flag = anarchy_at_samarra
			d_sunni = { has_title_flag = anarchy_at_samarra_happened }
		}
	}
	
	major_trigger = {
		OR = {
			religion_group = muslim
			capital_scope = {
				ROOT = {
					capital_scope = {
						NOT = {
							distance = {
								where = PREVPREV
								value = 600	# Same part of the world
							}
						}
					}
				}
			}
		}
	}

	mean_time_to_happen = {
		months = 12
		modifier = {
			factor = 0.5
			NOT = {
				diplomacy = 5
				martial = 5
				stewardship = 5
				intrigue = 5
			}
		}
	}
	
	option = {
		name = EVTOPTA_Plus_1900
		trigger = { has_landed_title = d_sunni }
		set_global_flag = anarchy_at_samarra
		d_sunni = { set_title_flag = anarchy_at_samarra_happened }
		add_trait = court_anarchy
		hidden_tooltip = {
			crownlaw_title = { add_law = infighting_0 }
		}
	}
	
	option = {
		name = EVTOPTB_Plus_1900
		trigger = {
			NOT = { has_landed_title = d_sunni }
			religion_group = muslim
		}
		tooltip = {
			ROOT = { add_trait = court_anarchy }
		}
	}
	option = {
		name = EVTOPTC_Plus_1900
		trigger = {
			NOT = { has_landed_title = d_sunni }
			NOT = { religion_group = muslim }
		}
		tooltip = {
			ROOT = { add_trait = court_anarchy }
		}
	}
}
	
# Succeeding caliph remains a prisoner
character_event = {
	id = Plus.1901
	desc = EVTDESC_Plus_1901
	picture = GFX_evt_throne_room_arabic
	
	is_triggered_only = yes
	
	trigger = {
		FROM = { title = d_sunni }
		has_global_flag = anarchy_at_samarra
		NOT = { trait = court_anarchy }
	}

	option = {
		name = EVTOPTA_Plus_1901
		add_trait = court_anarchy
		hidden_tooltip = {
			FROMFROM = { remove_trait = court_anarchy }
		}
	}
}

# Caliph succeeds at restoring order (fired from decision)
narrative_event = {
	id = Plus.1902
	title = EVTNAME_Plus_1902
	desc = EVTDESC_Plus_1902
	picture = GFX_evt_throne_room_arabic

	major = yes
	hide_from = yes
	show_ROOT = yes
	
	is_triggered_only = yes
	
	major_trigger = {
		OR = {
			religion_group = muslim
			capital_scope = {
				ROOT = {
					capital_scope = {
						NOT = {
							distance = {
								where = PREVPREV
								value = 600	# Same part of the world
							}
						}
					}
				}
			}
		}
	}
	
	option = {
		name = EVTOPTA_Plus_1902
		trigger = { has_landed_title = d_sunni }
		clr_global_flag = anarchy_at_samarra
		hidden_tooltip = {
			crownlaw_title = { revoke_law = infighting_0 }
		}
	}
	option = {
		name = EVTOPTB_Plus_1902
		trigger = {
			NOT = { has_landed_title = d_sunni }
			religion_group = muslim
		}
		if = {
			limit = { trait = court_anarchy }
			remove_trait = court_anarchy
		}
	}
	option = {
		name = OK
		trigger = {
			NOT = { has_landed_title = d_sunni }
			NOT = { religion_group = muslim }
		}
	}
}

# A random realm lord will declare independent while the anarchy reigns
character_event = {
	id = Plus.1903

	hide_window = yes
	
	only_playable = yes
	only_men = yes
	
	trigger = {
		has_landed_title = d_sunni
		trait = court_anarchy
		has_global_flag = anarchy_at_samarra
	}
	
	mean_time_to_happen = {
		years = 3
	}

	immediate = {
		random_vassal = {
			limit = {
				war = no
				real_tier = KING
				any_demesne_province = {
					any_neighbor_province = {
						owner = { NOT = { same_realm = ROOT } }
					}
				}
				NOT = {
					dynasty = ROOT
					opinion = { who = ROOT value = 0 }
					has_character_flag = refuse_caliph_breakaway
				}
			}
			character_event = { id = Plus.1904 }
			break = yes
		}
		random_vassal = {
			limit = {
				war = no
				real_tier = KING
				NOT = {
					dynasty = ROOT
					opinion = { who = ROOT value = 0 }
					has_character_flag = refuse_caliph_breakaway
				}
			}
			character_event = { id = Plus.1904 }
			break = yes
		}
		random_vassal = {
			limit = {
				war = no
				higher_tier_than = COUNT
				any_demesne_province = {
					any_neighbor_province = {
						owner = { NOT = { same_realm = ROOT } }
					}
				}
				NOT = {
					dynasty = ROOT
					opinion = { who = ROOT value = 0 }
					has_character_flag = refuse_caliph_breakaway
				}
			}
			character_event = { id = Plus.1904 }
			break = yes
		}
		random_vassal = {
			limit = {
				war = no
				higher_tier_than = COUNT
				NOT = {
					dynasty = ROOT
					opinion = { who = ROOT value = 0 }
					has_character_flag = refuse_caliph_breakaway
				}
			}
			character_event = { id = Plus.1904 }
			break = yes
		}
		random_vassal = {
			limit = {
				war = no
				higher_tier_than = COUNT
				any_demesne_province = {
					any_neighbor_province = {
						owner = { NOT = { same_realm = ROOT } }
					}
				}
				NOT = {
					dynasty = ROOT
					opinion = { who = ROOT value = 50 }
					has_character_flag = refuse_caliph_breakaway
				}
			}
			character_event = { id = Plus.1904 }
			break = yes
		}
		random_vassal = {
			limit = {
				war = no
				higher_tier_than = COUNT
				NOT = {
					dynasty = ROOT
					opinion = { who = ROOT value = 50 }
					has_character_flag = refuse_caliph_breakaway
				}
			}
			character_event = { id = Plus.1904 }
		}
	}
}

# Ruler decides whether or not to break free of the caliph
character_event = {
	id = Plus.1904
	desc = EVTDESC_Plus_1904
	picture = GFX_evt_throne_room
	
	is_triggered_only = yes

	option = {
		name = EVTOPTA_Plus_1904
		ai_chance = {
			factor = 4
		}
		set_defacto_liege = ROOT
		FROM = { character_event = { id = Plus.1905 } }
	}
	option = {
		name = EVTOPTB_Plus_1904
		ai_chance = {
			factor = 1
		}
		set_character_flag = refuse_caliph_breakaway
		piety = 50
	}
}

# Caliph hears of the ruler breaking free
character_event = {
	id = Plus.1905
	desc = EVTDESC_Plus_1905
	picture = GFX_evt_throne_room
	
	is_triggered_only = yes
	
	option = {
		name = CURSES
		opinion = {
			who = FROM
			modifier = opinion_rightful_vassal
			years = 20
		}
	}
}

### KHARIJITE REBELLION

# Kharijite rebels rise up in Mosul during the Anarchy at Samarra
province_event = {
	id = Plus.1906

	hide_window = yes
	
	trigger = {
		province_id = 697
		owner = {
			OR = {
				has_landed_title = d_sunni
				any_liege = { has_landed_title = d_sunni }
			}
		}
		has_global_flag = anarchy_at_samarra
		had_global_flag = { flag = startup days = 730 }
		NOT = { has_province_flag = kharijite_revolt }
	}
	
	mean_time_to_happen = {
		years = 5
		modifier = {
			factor = 0.1
			year = 866
		}
	}
	
	immediate = {	
		set_province_flag = kharijite_revolt
		if = {
			limit = { NOT = { religion = kharijite } }
			religion = kharijite
		}
		
		create_character = {
			random_traits = yes
			dynasty = none
			name = "Musawir"
			religion = kharijite
			culture = ROOT
			female = no
			age = 32
			attributes = {
				martial = 15
				learning = 7
			}
			trait = heresiarch
			trait = zealous
			trait = skilled_tactician
			trait = unyielding_leader
			trait = holy_warrior
		}		

		new_character = {
			set_character_flag = heretic_revolter			
			create_title = {
				tier = DUKE
				landless = yes
				temporary = yes
				rebel = yes
				culture = ROOT
				name = "Kharijite Rebellion"
				holder = THIS
			}			
			spawn_unit = {
				province = ROOT
				home = ROOT
				owner = THIS
				leader = THIS
				scaled_by_biggest_garrison = 2.7
				troops = {
					archers = { 6 6 }
					light_cavalry = { 4 4 }
					light_infantry = { 10 10 }
				}
				attrition = 0
				maintenance_multiplier = 0
			}
			create_character = {
				random_traits = yes
				dynasty = none
				religion = kharijite
				culture = THIS
				female = no
				age = 30
				attributes = {
					martial = 7
				}
				trait = skilled_tactician
				trait = peasant_leader
			}
			new_character = {
				spawn_unit = {
					province = ROOT
					home = ROOT
					owner = PREV
					scaled_by_biggest_garrison = 2.7
					troops = {
						archers = { 6 6 }
						light_cavalry = { 4 4 }
						light_infantry = { 10 10 }
					}
					attrition = 0.0
					disband_on_peace = yes
					maintenance_multiplier = 0
				}
			}
			create_character = {
				random_traits = yes
				dynasty = none
				religion = THIS
				culture = THIS
				female = no
				age = 23
				attributes = {
					martial = 7
				}
				trait = skilled_tactician
				trait = peasant_leader
			}
			new_character = {
				spawn_unit = {
					province = ROOT
					home = ROOT
					owner = PREV
					scaled_by_biggest_garrison = 2.7
					troops = {
						archers = { 6 6 }
						light_cavalry = { 4 4 }
						light_infantry = { 10 10 }
					}
					attrition = 0.0
					disband_on_peace = yes
					maintenance_multiplier = 0
				}
			}
			
			# DoW on the province top liege
			ROOT = {
				owner = {
					top_liege = {
						reverse_war = {
							target = PREVPREVPREV
							casus_belli = heretic_revolt
						}
						reverse_opinion = {
							who = PREVPREVPREV
							modifier = opinion_evil_tyrant
						}
					}
				}
			}
		}
		
		#inform the lieges
		owner = {
			top_liege = {
				character_event = { id = Plus.1907 }
			}
		}
	}
}

# Rulers informed of the kharaijite uprising
character_event = {
	id = Plus.1907
	desc = EVTDESC_Plus_1907
	picture = GFX_evt_heretic
	border = GFX_event_narrative_frame_war
	
	is_triggered_only = yes
	
	major = yes
	
	major_trigger = {
		OR = {
			same_realm = ROOT
			capital_scope = {
				ROOT = {
					capital_scope = {
						NOT = {
							distance = {
								where = PREVPREV
								value = 600	# Same part of the world
							}
						}
					}
				}
			}
		}
	}
	
	option = {
		name = EVTOPTA_Plus_1907
		trigger = {
			NOT = { religion = sunni }
		}
	}
	option = {
		name = EVTOPTB_Plus_1907
		trigger = {
			religion = sunni
		}
	}
}

