namespace = Plus

#reserved: Plus.1900 to Plus.1950

#######################################
# MUSLIM EVENTS
# Adapted from Heretic Pride by Rylock
#######################################

### ANARCHY AT SAMARRA EVENTS

# Caliphate administration seized from a weak caliph
narrative_event = {
	id = Plus.1900
	title = EVTNAME_Plus_1900
	desc = EVTDESC_Plus_1900
	picture = GFX_evt_throne_room_arabic
	
	major = yes
	hide_from = yes
	show_ROOT = yes
	
	only_playable = yes
	prisoner = no
	only_men = yes
	ai = yes
	
	trigger = {
		has_landed_title = d_sunni
		year = 800
		realm_size = 200
		NOT = {
			diplomacy = 10
			martial = 10
			stewardship = 10
			intrigue = 10
			has_global_flag = anarchy_at_samarra
			d_sunni = { has_title_flag = anarchy_at_samarra_happened }
		}
	}
	
	major_trigger = {
		OR = {
			religion_group = muslim
			capital_scope = {
				ROOT = {
					capital_scope = {
						NOT = {
							distance = {
								where = PREVPREV
								value = 600	# Same part of the world
							}
						}
					}
				}
			}
		}
	}

	mean_time_to_happen = {
		months = 12
		modifier = {
			factor = 0.5
			NOT = {
				diplomacy = 5
				martial = 5
				stewardship = 5
				intrigue = 5
			}
		}
	}
	
	option = {
		name = EVTOPTA_Plus_1900
		trigger = { has_landed_title = d_sunni }
		set_global_flag = anarchy_at_samarra
		d_sunni = { set_title_flag = anarchy_at_samarra_happened }
		add_trait = court_anarchy
		hidden_tooltip = {
			crownlaw_title = { add_law = infighting_0 }
		}
	}
	
	option = {
		name = EVTOPTB_Plus_1900
		trigger = {
			NOT = { has_landed_title = d_sunni }
			religion_group = muslim
		}
		tooltip = {
			ROOT = { add_trait = court_anarchy }
		}
	}
	option = {
		name = EVTOPTC_Plus_1900
		trigger = {
			NOT = { has_landed_title = d_sunni }
			NOT = { religion_group = muslim }
		}
		tooltip = {
			ROOT = { add_trait = court_anarchy }
		}
	}
}
	
# Succeeding caliph remains a prisoner
character_event = {
	id = Plus.1901
	desc = EVTDESC_Plus_1901
	picture = GFX_evt_throne_room_arabic
	
	is_triggered_only = yes
	
	trigger = {
		FROM = { title = d_sunni }
		has_global_flag = anarchy_at_samarra
		NOT = { trait = court_anarchy }
	}

	option = {
		name = EVTOPTA_Plus_1901
		add_trait = court_anarchy
		hidden_tooltip = {
			FROMFROM = { remove_trait = court_anarchy }
		}
	}
}

# Caliph succeeds at restoring order (fired from decision)
narrative_event = {
	id = Plus.1902
	title = EVTNAME_Plus_1902
	desc = EVTDESC_Plus_1902
	picture = GFX_evt_throne_room_arabic

	major = yes
	hide_from = yes
	show_ROOT = yes
	
	is_triggered_only = yes
	
	major_trigger = {
		OR = {
			religion_group = muslim
			capital_scope = {
				ROOT = {
					capital_scope = {
						NOT = {
							distance = {
								where = PREVPREV
								value = 600	# Same part of the world
							}
						}
					}
				}
			}
		}
	}
	
	option = {
		name = EVTOPTA_Plus_1902
		trigger = { has_landed_title = d_sunni }
		clr_global_flag = anarchy_at_samarra
		hidden_tooltip = {
			crownlaw_title = { revoke_law = infighting_0 }
		}
	}
	option = {
		name = EVTOPTB_Plus_1902
		trigger = {
			NOT = { has_landed_title = d_sunni }
			religion_group = muslim
		}
		if = {
			limit = { trait = court_anarchy }
			remove_trait = court_anarchy
		}
	}
	option = {
		name = OK
		trigger = {
			NOT = { has_landed_title = d_sunni }
			NOT = { religion_group = muslim }
		}
	}
}

# A random realm lord will declare independent while the anarchy reigns
character_event = {
	id = Plus.1903

	hide_window = yes
	
	only_playable = yes
	only_men = yes
	
	trigger = {
		has_landed_title = d_sunni
		trait = court_anarchy
		has_global_flag = anarchy_at_samarra
	}
	
	mean_time_to_happen = {
		years = 3
	}

	immediate = {
		random_vassal = {
			limit = {
				war = no
				real_tier = KING
				any_demesne_province = {
					any_neighbor_province = {
						owner = { NOT = { same_realm = ROOT } }
					}
				}
				NOT = {
					dynasty = ROOT
					opinion = { who = ROOT value = 0 }
					has_character_flag = refuse_caliph_breakaway
				}
			}
			character_event = { id = Plus.1904 }
			break = yes
		}
		random_vassal = {
			limit = {
				war = no
				real_tier = KING
				NOT = {
					dynasty = ROOT
					opinion = { who = ROOT value = 0 }
					has_character_flag = refuse_caliph_breakaway
				}
			}
			character_event = { id = Plus.1904 }
			break = yes
		}
		random_vassal = {
			limit = {
				war = no
				higher_tier_than = COUNT
				any_demesne_province = {
					any_neighbor_province = {
						owner = { NOT = { same_realm = ROOT } }
					}
				}
				NOT = {
					dynasty = ROOT
					opinion = { who = ROOT value = 0 }
					has_character_flag = refuse_caliph_breakaway
				}
			}
			character_event = { id = Plus.1904 }
			break = yes
		}
		random_vassal = {
			limit = {
				war = no
				higher_tier_than = COUNT
				NOT = {
					dynasty = ROOT
					opinion = { who = ROOT value = 0 }
					has_character_flag = refuse_caliph_breakaway
				}
			}
			character_event = { id = Plus.1904 }
			break = yes
		}
		random_vassal = {
			limit = {
				war = no
				higher_tier_than = COUNT
				any_demesne_province = {
					any_neighbor_province = {
						owner = { NOT = { same_realm = ROOT } }
					}
				}
				NOT = {
					dynasty = ROOT
					opinion = { who = ROOT value = 50 }
					has_character_flag = refuse_caliph_breakaway
				}
			}
			character_event = { id = Plus.1904 }
			break = yes
		}
		random_vassal = {
			limit = {
				war = no
				higher_tier_than = COUNT
				NOT = {
					dynasty = ROOT
					opinion = { who = ROOT value = 50 }
					has_character_flag = refuse_caliph_breakaway
				}
			}
			character_event = { id = Plus.1904 }
		}
	}
}

# Ruler decides whether or not to break free of the caliph
character_event = {
	id = Plus.1904
	desc = EVTDESC_Plus_1904
	picture = GFX_evt_throne_room
	
	is_triggered_only = yes

	option = {
		name = EVTOPTA_Plus_1904
		ai_chance = {
			factor = 4
		}
		set_defacto_liege = ROOT
		FROM = { character_event = { id = Plus.1905 } }
	}
	option = {
		name = EVTOPTB_Plus_1904
		ai_chance = {
			factor = 1
		}
		set_character_flag = refuse_caliph_breakaway
		piety = 50
	}
}

# Caliph hears of the ruler breaking free
character_event = {
	id = Plus.1905
	desc = EVTDESC_Plus_1905
	picture = GFX_evt_throne_room
	
	is_triggered_only = yes
	
	option = {
		name = CURSES
		opinion = {
			who = FROM
			modifier = opinion_rightful_vassal
			years = 20
		}
	}
}

### KHARIJITE REBELLION

# Kharijite rebels rise up in Mosul during the Anarchy at Samarra
province_event = {
	id = Plus.1906

	hide_window = yes
	
	trigger = {
		province_id = 697
		owner = {
			OR = {
				has_landed_title = d_sunni
				any_liege = { has_landed_title = d_sunni }
			}
		}
		has_global_flag = anarchy_at_samarra
		had_global_flag = { flag = startup days = 730 }
		NOT = { has_province_flag = kharijite_revolt }
	}
	
	mean_time_to_happen = {
		years = 5
		modifier = {
			factor = 0.1
			year = 866
		}
	}
	
	immediate = {	
		set_province_flag = kharijite_revolt
		if = {
			limit = { NOT = { religion = kharijite } }
			religion = kharijite
		}
		
		create_character = {
			random_traits = yes
			dynasty = none
			name = "Musawir"
			religion = kharijite
			culture = ROOT
			female = no
			age = 32
			attributes = {
				martial = 15
				learning = 7
			}
			trait = heresiarch
			trait = zealous
			trait = skilled_tactician
			trait = unyielding_leader
			trait = holy_warrior
		}		

		new_character = {
			set_character_flag = heretic_revolter			
			create_title = {
				tier = DUKE
				landless = yes
				temporary = yes
				rebel = yes
				culture = ROOT
				name = "Kharijite Rebellion"
				holder = THIS
			}			
			spawn_unit = {
				province = ROOT
				home = ROOT
				owner = THIS
				leader = THIS
				scaled_by_biggest_garrison = 2.0
				troops = {
					archers = { 6 6 }
					light_cavalry = { 4 4 }
					light_infantry = { 10 10 }
				}
				attrition = 0
				maintenance_multiplier = 0
			}
			create_character = {
				random_traits = yes
				dynasty = none
				religion = kharijite
				culture = THIS
				female = no
				age = 30
				attributes = {
					martial = 7
				}
				trait = skilled_tactician
				trait = peasant_leader
			}
			new_character = {
				spawn_unit = {
					province = ROOT
					home = ROOT
					owner = PREV
					scaled_by_biggest_garrison = 2.0
					troops = {
						archers = { 6 6 }
						light_cavalry = { 4 4 }
						light_infantry = { 10 10 }
					}
					attrition = 0.0
					disband_on_peace = yes
					maintenance_multiplier = 0
				}
			}
			create_character = {
				random_traits = yes
				dynasty = none
				religion = THIS
				culture = THIS
				female = no
				age = 23
				attributes = {
					martial = 7
				}
				trait = skilled_tactician
				trait = peasant_leader
			}
			new_character = {
				spawn_unit = {
					province = ROOT
					home = ROOT
					owner = PREV
					scaled_by_biggest_garrison = 2.0
					troops = {
						archers = { 6 6 }
						light_cavalry = { 4 4 }
						light_infantry = { 10 10 }
					}
					attrition = 0.0
					disband_on_peace = yes
					maintenance_multiplier = 0
				}
			}
			
			# DoW on the province top liege
			ROOT = {
				owner = {
					top_liege = {
						reverse_war = {
							target = PREVPREVPREV
							casus_belli = heretic_revolt
						}
						reverse_opinion = {
							who = PREVPREVPREV
							modifier = opinion_evil_tyrant
						}
					}
				}
			}
		}
		
		#inform the lieges
		owner = {
			top_liege = {
				character_event = { id = Plus.1907 }
			}
		}
	}
}

# Rulers informed of the kharajite uprising
character_event = {
	id = Plus.1907
	desc = EVTDESC_Plus_1907
	picture = GFX_evt_heretic
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes
	
	major = yes
	
	major_trigger = {
		OR = {
			same_realm = ROOT
			capital_scope = {
				ROOT = {
					capital_scope = {
						NOT = {
							distance = {
								where = PREVPREV
								value = 600	# Same part of the world
							}
						}
					}
				}
			}
		}
	}
	
	option = {
		name = EVTOPTA_Plus_1907
		trigger = {
			NOT = { religion = sunni }
		}
	}
	option = {
		name = EVTOPTB_Plus_1907
		trigger = {
			religion = sunni
		}
	}
}

### ADDITIONAL DECADENCE EVENTS

# Rulers of a very large empire may gain decadence
character_event = {
	id = Plus.1910
	desc = EVTDESC_Plus_1910
	picture = GFX_evt_sultan
	
	only_men = yes
	only_independent = yes
	
	trigger = {
		religion_group = muslim
		realm_size = 150
		any_dynasty_member = { is_alive = yes count = 3 } # Does not trigger for tiny dynasties
		OR = {
			NOT = { has_character_flag = decadence_change_empire }
			had_character_flag = { flag = decadence_change_empire days = 3650 }
		}
	}
	
	mean_time_to_happen = {
		months = 240
		modifier = {
			factor = 0.8
			realm_size = 175
		}
		modifier = {
			factor = 0.8
			realm_size = 200
		}
		modifier = {
			factor = 0.8
			realm_size = 225
		}
		modifier = {
			factor = 0.8
			realm_size = 250
		}
		modifier = {
			factor = 0.8
			realm_size = 275
		}
		modifier = {
			factor = 0.8
			realm_size = 300
		}
		modifier = {
			factor = 1.2
			decadence = 50
		}
		modifier = {
			factor = 1.2
			decadence = 60
		}
		modifier = {
			factor = 1.2
			decadence = 70
		}
		modifier = {
			factor = 1.2
			decadence = 80
		}
		modifier = {
			factor = 1.2
			decadence = 90
		}
		modifier = {
			factor = 0.75
			trait = decadent
		}
	}

	option = {
		name = EVTOPTA_Plus_1910
		trigger = { NOT = { trait = decadent } }
		set_character_flag = decadence_change_empire
		decadence = 5
	}
	option = {
		name = EVTOPTB_Plus_1910
		trigger = { trait = decadent }
		set_character_flag = decadence_change_empire
		decadence = 5
	}
}

# Provinces under the ruler of a very decadent dynasty may gain unrest
province_event = {
	id = Plus.1911

	hide_window = yes
	
	trigger = {
		owner = {
			top_liege = {
				religion_group = muslim
				religion_group = ROOT
				decadence = 50
				OR = {
					NOT = { has_character_flag = decadence_unrest_event }
					had_character_flag = { flag = decadence_unrest_event days = 730 }
				}
			}
		}
		OR = {
			NOT = { has_province_flag = crushed_decadence_unrest }
			had_province_flag = { flag = crushed_decadence_unrest days = 3650 }
		}
		NOT = { has_province_modifier = decadence_unrest }
	}
	
	mean_time_to_happen = {
		months = 1200
		modifier = {
			factor = 0.75
			owner = { top_liege = { decadence = 60 } }
		}
		modifier = {
			factor = 0.75
			owner = { top_liege = { decadence = 70 } }
		}
		modifier = {
			factor = 0.75
			owner = { top_liege = { decadence = 80 } }
		}
		modifier = {
			factor = 0.75
			owner = { top_liege = { decadence = 90 } }
		}
		modifier = {
			factor = 1.5
			owner = {
				top_liege = {
					any_realm_province = {
						has_province_modifier = decadence_unrest
						count = 5
					}
				}
			}
		}
		modifier = {
			factor = 2.0
			owner = {
				top_liege = {
					any_realm_province = {
						has_province_modifier = decadence_unrest
						count = 10
					}
				}
			}
		}
	}
	
	immediate = {
		owner = {
			top_liege = {
				set_character_flag = decadence_unrest_event
				character_event = { id = Plus.1912 }
			}
		}
	}
}

character_event = {
	id = Plus.1912
	desc = EVTDESC_Plus_1912
	picture = GFX_evt_imam
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_Plus_1912 #Ignore it
		ai_chance = {
			factor = 50
			modifier = {
				factor = 0.5
				trait = cruel
			}
			modifier = {
				factor = 0.5
				trait = diligent
			}
			modifier = {
				factor = 0.5
				trait = paranoid
			}
			modifier = {
				factor = 0.5
				trait = zealous
			}
		}
		FROM = {
			add_province_modifier = {
				name = decadence_unrest
				duration = 1825
			}
		}
	}
	option = {
		name = EVTOPTB_Plus_1912 #Deal harshly with those responsible
		ai_chance = {
			factor = 50
			modifier = {
				factor = 0.5
				trait = kind
			}
			modifier = {
				factor = 0.5
				trait = slothful
			}
			modifier = {
				factor = 0.5
				trait = trusting
			}
			modifier = {
				factor = 0.5
				trait = cynical
			}
			modifier = {
				factor = 0.25
				trait = decadent
			}
			modifier = {
				factor = 0
				OR = {
					trait = tyrant10
					trait = tyrant11
					trait = tyrant12
					trait = tyrant13
					trait = tyrant14
					trait = tyrant15
					trait = tyrant16
					trait = tyrant17
					trait = tyrant18
					trait = tyrant19
					trait = tyrant20
				}
			}
		}
		FROM = { set_province_flag = crushed_decadence_unrest }
		if = {
			limit = {
				trait = tyrant19
			}
			remove_trait = tyrant19
			add_trait = tyrant20
		}
		if = {
			limit = {
				trait = tyrant18
			}
			remove_trait = tyrant18
			add_trait = tyrant19
		}
		if = {
			limit = {
				trait = tyrant17
			}
			remove_trait = tyrant17
			add_trait = tyrant18
		}
		if = {
			limit = {
				trait = tyrant16
			}
			remove_trait = tyrant16
			add_trait = tyrant17
		}
		if = {
			limit = {
				trait = tyrant15
			}
			remove_trait = tyrant15
			add_trait = tyrant16
		}
		if = {
			limit = {
				trait = tyrant14
			}
			remove_trait = tyrant14
			add_trait = tyrant15
		}
		if = {
			limit = {
				trait = tyrant13
			}
			remove_trait = tyrant13
			add_trait = tyrant14
		}
		if = {
			limit = {
				trait = tyrant12
			}
			remove_trait = tyrant12
			add_trait = tyrant13
		}
		if = {
			limit = {
				trait = tyrant11
			}
			remove_trait = tyrant11
			add_trait = tyrant12
		}
		if = {
			limit = {
				trait = tyrant10
			}
			remove_trait = tyrant10
			add_trait = tyrant11
		}
		if = {
			limit = {
				trait = tyrant9
			}
			remove_trait = tyrant9
			add_trait = tyrant10
		}
		if = {
			limit = {
				trait = tyrant8
			}
			remove_trait = tyrant8
			add_trait = tyrant9
		}
		if = {
			limit = {
				trait = tyrant7
			}
			remove_trait = tyrant7
			add_trait = tyrant8
		}
		if = {
			limit = {
				trait = tyrant6
			}
			remove_trait = tyrant6
			add_trait = tyrant7
		}
		if = {
			limit = {
				trait = tyrant5
			}
			remove_trait = tyrant5
			add_trait = tyrant6
		}
		if = {
			limit = {
				trait = tyrant4
			}
			remove_trait = tyrant4
			add_trait = tyrant5
		}
		if = {
			limit = {
				trait = tyrant3
			}
			remove_trait = tyrant3
			add_trait = tyrant4
		}
		if = {
			limit = {
				trait = tyrant2
			}
			remove_trait = tyrant2
			add_trait = tyrant3
		}
		if = {
			limit = {
				trait = tyrant1
			}
			remove_trait = tyrant1
			add_trait = tyrant2
		}
		if = {
			limit = {
				NOT = {
					trait = tyrant1
					trait = tyrant2
					trait = tyrant3
					trait = tyrant4
					trait = tyrant5
					trait = tyrant6
					trait = tyrant7
					trait = tyrant8
					trait = tyrant9
					trait = tyrant10
					trait = tyrant11
					trait = tyrant12
					trait = tyrant13
					trait = tyrant14
					trait = tyrant15
					trait = tyrant16
					trait = tyrant17
					trait = tyrant18
					trait = tyrant19
					trait = tyrant20
				}
			}
			add_trait = tyrant1
		}
	}
}	

# Province with decadence unrest calms down if decadence is reduced
province_event = {
	id = Plus.1913
	
	hide_window = yes
	
	trigger = {
		has_province_modifier = decadence_unrest
		NOT = {
			owner = {
				top_liege = {
					religion_group = muslim
					religion_group = ROOT
					decadence = 50
				}
			}
		}
	}
	
	mean_time_to_happen = {
		months = 12
	}
	
	immediate = {
		remove_province_modifier = decadence_unrest
	}
}

